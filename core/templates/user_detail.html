{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ profile_user.username }} - PequiEater{% endblock %}

{% block main_header %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4">PequiEater</h1>
            <div class="subtitle">lugar de roer</div>
        </div>
        <div class="d-flex gap-3 align-items-center">
            {% if user.is_authenticated %}
                <a href="{% url 'post-list' %}" class="btn btn-warning">Comece a roer</a>
                <a href="{% url 'user-detail' user.pk %}" class="btn btn-warning">Meu Perfil</a>
            {% endif %}
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button class="btn-logout">Logout</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="main-content">
        <div class="flex-grow-1">
            <div class="card p-4 shadow-sm mb-4">
                <h2 class="username">{{ profile_user.username }}</h2>
                <p class="text-muted">{{ profile_user.email }}</p>
                <div id="profile-info">
                    <p>{{ profile_user.bio|linebreaks }}</p>
                </div>

                {% if not is_own_profile %}
                    <div
                        id="follow-button"
                        hx-post="{% url 'api-user-toggle-follow' profile_user.pk %}"
                        hx-swap="outerHTML"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    >
                        {% if user in profile_user.followers.all %}
                            <button class="btn btn-outline-secondary">Deixar de seguir</button>
                        {% else %}
                            <button class="btn btn-primary">Seguir</button>
                        {% endif %}
                    </div>
                {% endif %}

                {% if is_own_profile %}
                    <button class="btn btn-secondary mt-2"
                            hx-get="{% url 'user-detail' user.pk %}?edit=true"
                            hx-target="#edit-form-container"
                            hx-swap="innerHTML">
                        Editar perfil
                    </button>
                {% endif %}
            </div>

            <div id="edit-form-container">
                {% if is_own_profile and form %}
                    <form method="post">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div class="sidebar">
            <div class="card p-4 shadow-sm">
                <h3>Seguindo</h3>
                {% if following %}
                    <ul class="list-group">
                        {% for u in following %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ u.username }}
                                <div
                                    hx-post="{% url 'api-user-toggle-follow' u.pk %}"
                                    hx-swap="outerHTML"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                >
                                    {% if u in user.following.all %}
                                        <button class="btn btn-sm btn-outline-secondary">Deixar de seguir</button>
                                    {% else %}
                                        <button class="btn btn-sm btn-primary">Seguir</button>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">Você não está seguindo ninguém ainda.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}